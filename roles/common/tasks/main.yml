- name: Add joe user
  user:
    name: joe
    shell: /bin/bash
    groups: sudo
    append: yes
  become: true

- name: Create required directories
  file:
    path: "{{ item }}"
    state: directory
    mode: 0755
  with_items:
      - /var/www
      - /etc/apache2/sites-enabled
  become: true

- name: Install apt repositories
  apt:
    update_cache: yes
    name: "{{ item }}"
  become: true
  with_items:
      - apache2
      - automysqlbackup
      - fail2ban
      - git
      - php7.0
      - php7.0-curl
      - php7.0-mbstring
      - php7.0-simplexml

- name: Clone git repos
  git:
      repo: "https://github.com/joereynolds/{{ item }}"
      dest: "/var/www/{{ item }}"
  with_items:
      - boganspunkrock
      - util.joereynoldsaudio
      - joereynoldsaudio
      - metronome
  become: true

- name: Enable Apache rewrite module
  apache2_module:
    state: present
    name: rewrite
  become: true

- name: Copy Apache configurations
  copy:
    src: ./roles/common/files/{{ item }}
    dest: /etc/apache2/sites-enabled/{{ item }}
  with_items:
      - boganspunkrock.conf
      - staging.boganspunkrock.conf
      - metronome.joereynoldsaudio.conf
      - util.joereynoldsaudio.conf
  become: true
